@{
    ViewData["Title"] = "CanlÄ± Sohbet - Admin Paneli";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Admin Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand">Admin Paneli</span>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/Admin/Index">ğŸ“¦ SipariÅŸler</a>
            <a class="nav-link active" href="/Admin/Chat">ğŸ’¬ CanlÄ± Sohbet</a>
            <a class="nav-link" href="/Login/Logout">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-chat-left-dots me-2" style="color: #FF6B35;"></i>
                <strong>CanlÄ± MÃ¼ÅŸteri Destek Sohbeti</strong>
            </h2>
        </div>
    </div>

    <div class="row">
        <!-- Sol Taraf: Aktif KonuÅŸmalar Listesi -->
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2" style="color: #FF6B35;"></i>
                        Aktif MÃ¼ÅŸteriler
                    </h5>
                </div>
                <div class="list-group list-group-flush" id="customerList">
                    <div class="list-group-item p-3 text-center text-muted">
                        <i class="bi bi-hourglass-split me-2"></i>
                        <small>MÃ¼ÅŸteri baÄŸlantÄ±sÄ± bekleniyor...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- SaÄŸ Taraf: Sohbet Penceresi -->
        <div class="col-lg-9">
            <div class="card shadow-sm border-0 h-100">
                <!-- BaÅŸlÄ±k: SeÃ§ili MÃ¼ÅŸteri Bilgisi -->
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-chat-left-text me-2" style="color: #FF6B35;"></i>
                            <span id="selectedCustomerName">MÃ¼ÅŸteri SeÃ§iniz</span>
                        </h5>
                        <small id="selectedCustomerStatus" class="text-muted d-block mt-1">Ã‡evrimdÄ±ÅŸÄ±</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="closeConversation()">
                        <i class="bi bi-x-circle me-1"></i> Kapat
                    </button>
                </div>

                <!-- Sohbet MesajlarÄ± AlanÄ± -->
                <div id="adminChatMessages" style="height: 400px; overflow-y: auto; background: #f9f9f9; padding: 20px; display: flex; flex-direction: column; gap: 10px;">
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">Sohbet seÃ§iniz veya mÃ¼ÅŸteri baÄŸlantÄ± kurmasÄ±nÄ± bekleyiniz</p>
                    </div>
                </div>

                <!-- Ä°nput AlanÄ± -->
                <div class="card-footer bg-white border-top p-3">
                    <div class="input-group">
                        <input type="text" id="adminMessageInput" class="form-control" placeholder="CevabÄ±nÄ±zÄ± yazÄ±nÄ±z..." />
                        <button class="btn btn-success" onclick="sendAdminMessage()">
                            <i class="bi bi-send-fill me-1"></i> GÃ¶nder
                        </button>
                    </div>
                    <div id="typingIndicator" class="mt-2 text-muted" style="display: none;">
                        <small><i class="bi bi-pencil me-1"></i> <span id="typingCustomerName">MÃ¼ÅŸteri</span> yazÄ±yor...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Panel Ä°Ã§in SignalR Betikleri -->
<script>
    // ğŸ“Œ Admin Paneli iÃ§in SignalR BaÄŸlantÄ±sÄ±
    let selectedCustomerId = null;
    let adminName = "Destek Ekibi";
    let customersInfo = {}; // MÃ¼ÅŸteri bilgileri (ID -> {name, IP})

    // TarayÄ±cÄ± bildirim izni iste
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }

    // Admin baÄŸlantÄ±sÄ±nÄ± kur
    const adminConnection = new signalR.HubConnectionBuilder()
        .withUrl("/hubs/chat")
        .withAutomaticReconnect()
        .build();

    // Admin grubuna ait mÃ¼ÅŸteriden mesaj al
    adminConnection.on("ReceiveCustomerMessage", (data) => {
        console.log("MÃ¼ÅŸteri mesajÄ±:", data.message, "GÃ¶nderen:", data.userName, "CustomerId:", data.customerId);
        
        // EÄŸer bu mÃ¼ÅŸterinin konuÅŸmasÄ± seÃ§iliyse, mesajÄ± gÃ¶ster
        if (selectedCustomerId === data.customerId) {
            displayAdminChatMessage(data.message, data.userName, false);
        }
        
        // Bildirim gÃ¶ster
        showCustomerNotification(data.customerId, data.userName, data.message);
    });

    // MÃ¼ÅŸteri bildirim mesajÄ± aldÄ±ÄŸÄ±nda

    // Chat geÃ§miÅŸi yÃ¼kle
    adminConnection.on("LoadChatHistory", (messages) => {
        console.log("Chat geÃ§miÅŸi yÃ¼klendi:", messages.length, "mesaj");
        let chatBox = document.getElementById("adminChatMessages");
        chatBox.innerHTML = ""; // Ã–nce temizle

        if (messages.length === 0) {
            chatBox.innerHTML = `
                <div class="text-center text-muted">
                    <small>HenÃ¼z mesaj yok</small>
                </div>
            `;
            return;
        }

        // GeÃ§miÅŸ mesajlarÄ± gÃ¶ster
        messages.forEach(msg => {
            displayAdminChatMessage(msg.message, msg.senderName, msg.isAdmin);
        });
    });

    // MÃ¼ÅŸteri yazÄ±yor gÃ¶stergesi
    adminConnection.on("ShowCustomerTyping", (data) => {
        if (selectedCustomerId === data.customerId) {
            showAdminTypingIndicator(data.customerName);
        }
    });
    // YazÄ±yor gÃ¶stergesini kaldÄ±r
    adminConnection.on("StopTyping", (customerId) => {
        if (selectedCustomerId === customerId) {
            hideAdminTypingIndicator();
        }
    });

    // MÃ¼ÅŸteri baÄŸlandÄ±ÄŸÄ±nda
    adminConnection.on("CustomerConnected", (data) => {
        console.log("MÃ¼ÅŸteri baÄŸlandÄ±:", data.customerName);
        addCustomerToList(data.customerId, data.customerName, true, data.ipAddress);
        
        // Ä°lk mÃ¼ÅŸteri otomatik seÃ§ilsin
        if (!selectedCustomerId) {
            selectCustomer(data.customerId, data.customerName);
        }
    });

    // MÃ¼ÅŸteri ayrÄ±ldÄ±ÄŸÄ±nda
    adminConnection.on("CustomerDisconnected", (customerId) => {
        console.log("MÃ¼ÅŸteri ayrÄ±ldÄ±");
        updateCustomerStatus(customerId, false);
    });

    // SignalR baÄŸlantÄ±sÄ±nÄ± baÅŸlat
    adminConnection.start()
        .then(() => {
            console.log("âœ… Admin SignalR Chat Hub baÄŸlantÄ±sÄ± kuruldu!");
        })
        .catch(err => {
            console.error("âŒ Admin SignalR Chat Hub HatasÄ±:", err);
        });

    // MÃ¼ÅŸteri listesine mÃ¼ÅŸteri ekle
    function addCustomerToList(customerId, customerName, isOnline, ipAddress) {
        let customerList = document.getElementById("customerList");
        let existingItem = document.getElementById("customer-" + customerId);

        // MÃ¼ÅŸteri bilgisini sakla
        customersInfo[customerId] = {
            name: customerName,
            ip: ipAddress
        };

        if (existingItem) {
            // Var olan mÃ¼ÅŸteriyi gÃ¼ncelle
            existingItem.classList.toggle("list-group-item-info", isOnline);
            return;
        }

        // BoÅŸ mesajÄ± kaldÄ±r
        if (customerList.children.length === 1 && customerList.children[0].classList.contains("text-muted")) {
            customerList.innerHTML = "";
        }

        // Yeni mÃ¼ÅŸteri Ã¶ÄŸesi oluÅŸtur
        let customerItem = document.createElement("div");
        customerItem.id = "customer-" + customerId;
        customerItem.className = "list-group-item p-3 cursor-pointer" + (isOnline ? " list-group-item-info" : "");
        customerItem.style.cursor = "pointer";
        customerItem.style.position = "relative";
        customerItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div style="flex: 1;">
                    <strong>${escapeHtml(customerName)}</strong>
                    <small class="d-block text-muted">${isOnline ? 'ğŸŸ¢ Ã‡evrimiÃ§i' : 'âš« Ã‡evrimdÄ±ÅŸÄ±'}</small>
                    <small class="d-block text-muted" style="font-size: 0.75rem; margin-top: 4px;">ğŸ”— IP: ${escapeHtml(ipAddress)}</small>
                </div>
                <span id="badge-${customerId}" class="badge bg-danger" style="display: none; font-size: 0.7rem;">Yeni Mesaj</span>
            </div>
        `;

        customerItem.onclick = () => selectCustomer(customerId, customerName);
        customerList.appendChild(customerItem);
    }

    // MÃ¼ÅŸteri seÃ§
    function selectCustomer(customerId, customerName) {
        selectedCustomerId = customerId;
        
        // MÃ¼ÅŸteri bilgisini al
        let customerInfo = customersInfo[customerId] || { name: customerName, ip: "Bilinmiyor" };
        
        document.getElementById("selectedCustomerName").textContent = customerInfo.name + " - ğŸ”— " + customerInfo.ip;
        document.getElementById("selectedCustomerStatus").textContent = "ğŸŸ¢ KonuÅŸma AÃ§Ä±k";
        document.getElementById("adminChatMessages").innerHTML = ""; // Sohbeti temizle
        
        // MÃ¼ÅŸteri seÃ§imini vurgula
        document.querySelectorAll(".list-group-item").forEach(item => {
            item.classList.remove("active");
        });
        document.getElementById("customer-" + customerId).classList.add("active");

        // Bildirim badge'ini kaldÄ±r
        removeCustomerNotification(customerId);

        // Chat geÃ§miÅŸini Ã§ek
        adminConnection.invoke("GetChatHistory", customerId)
            .catch(err => console.error("Sohbet geÃ§miÅŸi yÃ¼kleme hatasÄ±:", err));

        console.log("MÃ¼ÅŸteri seÃ§ildi:", customerName);
    }

    // Admin mesajÄ± gÃ¶nder
    function sendAdminMessage() {
        if (!selectedCustomerId) {
            alert("LÃ¼tfen mÃ¼ÅŸteri seÃ§iniz!");
            return;
        }

        let messageInput = document.getElementById("adminMessageInput");
        let message = messageInput.value.trim();

        if (!message) return;

        // MesajÄ± ekrana ekle (yeÅŸil, saÄŸ taraf)
        displayAdminChatMessage(message, "Siz", true);

        // SignalR Ã¼zerinden mÃ¼ÅŸteriye gÃ¶nder
        console.log("MÃ¼ÅŸteriye mesaj gÃ¶nderiliyor:", message, "CustomerId:", selectedCustomerId);
        adminConnection.invoke("SendMessageToCustomer", message, "Destek Ekibi", selectedCustomerId)
            .catch(err => console.error("Mesaj gÃ¶nderme hatasÄ±:", err));

        messageInput.value = "";
    }

    // Admin sohbet mesajÄ±nÄ± gÃ¶ster
    function displayAdminChatMessage(message, senderName, isAdmin) {
        let chatBox = document.getElementById("adminChatMessages");
        
        // Ä°lk mesajÄ±ysa boÅŸ mesajÄ± kaldÄ±r
        if (chatBox.children[0]?.classList.contains("text-muted")) {
            chatBox.innerHTML = "";
        }

        let bubble = document.createElement("div");
        bubble.className = "d-flex " + (isAdmin ? "justify-content-end" : "justify-content-start");

        let bgColor = isAdmin ? "#25d366" : "#e8f5e9";
        let textColor = isAdmin ? "white" : "#333";

        bubble.innerHTML = `
            <div style="background: ${bgColor}; color: ${textColor}; padding: 10px 14px; border-radius: 8px; max-width: 70%; word-wrap: break-word;">
                <strong style="display: block; font-size: 0.85rem; margin-bottom: 4px;">${escapeHtml(senderName)}</strong>
                ${escapeHtml(message)}
                <small style="display: block; margin-top: 4px; opacity: 0.7; font-size: 0.8rem;">${new Date().toLocaleTimeString('tr-TR')}</small>
            </div>
        `;

        chatBox.appendChild(bubble);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // YazÄ±yor gÃ¶stergesini gÃ¶ster
    function showAdminTypingIndicator(customerName) {
        let typingDiv = document.getElementById("typingIndicator");
        document.getElementById("typingCustomerName").textContent = customerName;
        typingDiv.style.display = "block";
    }

    // YazÄ±yor gÃ¶stergesini gizle
    function hideAdminTypingIndicator() {
        document.getElementById("typingIndicator").style.display = "none";
    }

    // MÃ¼ÅŸteri bildirim gÃ¶ster
    function showCustomerNotification(customerId, customerName, messagePreview) {
        // Browser bildirim gÃ¶ster
        if (Notification.permission === "granted") {
            new Notification(`Yeni Mesaj - ${customerName}`, {
                body: messagePreview,
                icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23FF6B35'/><text x='50' y='60' text-anchor='middle' font-size='60' fill='white'>ğŸ’¬</text></svg>"
            });
        }

        // Bildirim sesi Ã§al
        playNotificationSound();

        // Sayfa Ã¼zerinde badge gÃ¶ster
        let badge = document.getElementById("badge-" + customerId);
        if (badge) {
            badge.style.display = "inline-block";
        }
    }

    // Bildirim sesi Ã§al
    function playNotificationSound() {
        const audio = new Audio("data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQIAAAAAAA==");
        audio.volume = 0.5;
        audio.play().catch(() => {
            // Ses Ã§alÄ±namazsa sessiz devam et
        });
    }

    // MÃ¼ÅŸteri bildirim kaldÄ±r
    function removeCustomerNotification(customerId) {
        let badge = document.getElementById("badge-" + customerId);
        if (badge) {
            badge.style.display = "none";
        }
    }
    function updateCustomerStatus(customerId, isOnline) {
        let customerItem = document.getElementById("customer-" + customerId);
        if (customerItem) {
            let statusText = customerItem.querySelector("small");
            if (statusText) {
                statusText.textContent = isOnline ? "ğŸŸ¢ Ã‡evrimiÃ§i" : "âš« Ã‡evrimdÄ±ÅŸÄ±";
            }
        }
    }

    // KonuÅŸmayÄ± kapat
    function closeConversation() {
        selectedCustomerId = null;
        document.getElementById("selectedCustomerName").textContent = "MÃ¼ÅŸteri SeÃ§iniz";
        document.getElementById("selectedCustomerStatus").textContent = "Ã‡evrimdÄ±ÅŸÄ±";
        document.getElementById("adminChatMessages").innerHTML = `
            <div class="text-center text-muted mt-5">
                <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
                <p class="mt-2">Sohbet seÃ§iniz</p>
            </div>
        `;
    }

    // HTML Ã¶zel karakterleri kaÃ§Ä±ÅŸ yapan fonksiyon
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Enter tuÅŸu ile mesaj gÃ¶nder
    document.addEventListener("DOMContentLoaded", function() {
        let adminMessageInput = document.getElementById("adminMessageInput");
        if (adminMessageInput) {
            adminMessageInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendAdminMessage();
                }
            });
        }
    });
</script>

<style>
    .cursor-pointer {
        cursor: pointer;
    }

    .list-group-item.active {
        background-color: #25d366 !important;
        border-color: #25d366 !important;
        color: white !important;
    }

    .list-group-item.list-group-item-info {
        background-color: #f0f9ff !important;
        border-left: 3px solid #25d366;
    }

    .list-group-item:hover {
        background-color: #f9f9f9;
        transition: all 0.2s ease;
    }

    #adminChatMessages {
        background: linear-gradient(135deg, #f5f5f5 0%, #fafafa 100%);
        border-radius: 8px;
    }
</style>
